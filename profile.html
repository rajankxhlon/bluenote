<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Global Styles */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            background-color: #121212; /* Dark background */
            color: #f5f5f5; /* Light text for dark theme */
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* Header */
        .header {
            background-color: #1a1a1a;
            border-bottom: 1px solid #262626;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .header .left-section {
            display: flex;
            align-items: center;
        }

        .header .username-display {
            font-weight: bold;
            font-size: 20px;
            color: #f5f5f5;
            display: flex;
            align-items: center;
        }

        .header .verified-badge {
            width: 18px;
            height: 18px;
            margin-left: 5px;
            vertical-align: middle;
        }

        .header .menu-icon {
            font-size: 24px;
            color: #f5f5f5;
            cursor: pointer;
        }

        /* NEW: Menu Overlay and Content */
        .menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px); /* Optional: blur effect */
            z-index: 1001;
            display: none; /* Hidden by default */
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .menu-overlay.active {
            display: block;
            opacity: 1;
        }

        .menu-content {
            position: absolute;
            top: 0;
            right: 0;
            width: 250px; /* Width of the menu */
            height: 100%;
            background-color: #1a1a1a;
            border-left: 1px solid #262626;
            transform: translateX(100%); /* Start off-screen */
            transition: transform 0.3s ease;
            display: flex;
            flex-direction: column;
            padding: 20px;
            box-sizing: border-box;
        }

        .menu-overlay.active .menu-content {
            transform: translateX(0); /* Slide in */
        }

        .menu-header {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 20px;
        }

        .menu-header .close-icon {
            font-size: 24px;
            color: #f5f5f5;
            cursor: pointer;
        }

        .menu-item {
            display: block;
            width: 100%;
            padding: 15px 10px;
            margin-bottom: 10px;
            background-color: #262626;
            color: #f5f5f5;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            text-align: left;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.1s ease;
            text-decoration: none; /* For anchor tags if used */
        }

        .menu-item:hover {
            background-color: #363636;
            transform: translateY(-2px);
        }

        .menu-item:active {
            transform: translateY(0);
        }


        /* Main Content Area */
        .main-content {
            flex-grow: 1;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .profile-section {
            width: 100%;
            max-width: 600px;
            background-color: #1a1a1a;
            border-radius: 8px;
            padding: 20px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        .profile-picture-container {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background-color: #363636;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            margin-bottom: 10px;
            border: 2px solid #363636; /* Default border */
        }

        .profile-picture-container.editable {
            cursor: pointer;
        }

        .profile-picture-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        .profile-picture-container .initials {
            font-size: 50px;
            font-weight: bold;
            color: #f5f5f5;
        }

        .bio-section {
            width: 100%;
            text-align: center;
            padding: 0 10px;
        }

        .bio-text {
            color: #f5f5f5;
            font-size: 15px;
            margin-bottom: 10px;
            white-space: pre-wrap; /* Preserve whitespace and break lines */
        }

        .stats-section {
            display: flex;
            justify-content: space-around;
            width: 100%;
            max-width: 400px; /* Limit width for stats */
            margin-top: 20px;
        }

        .stat-item {
            text-align: center;
            flex: 1;
        }

        .stat-item .count {
            font-weight: bold;
            font-size: 18px;
            color: #f5f5f5;
        }

        .stat-item .label {
            font-size: 14px;
            color: #8e8e8e;
            margin-top: 2px;
        }

        .profile-actions {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        .profile-actions button {
            background-color: #333333;
            color: #f5f5f5;
            border: 1px solid #555555;
            border-radius: 5px;
            padding: 10px 20px;
            font-size: 15px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .profile-actions button:hover {
            background-color: #444444;
        }

        .user-posts-section {
            width: 100%;
            max-width: 600px;
            margin-top: 30px;
            border-top: 1px solid #262626;
            padding-top: 20px;
        }

        .user-posts-section h3 {
            text-align: center;
            color: #f5f5f5;
            margin-bottom: 20px;
        }

        /* Post Card Styles */
        .post-card {
            background-color: #1a1a1a;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            margin-bottom: 20px;
            width: 100%; /* Take full width of its container */
            overflow: hidden;
            cursor: pointer;
        }

        .post-card:hover {
            background-color: #212121; /* Slight hover effect */
        }

        .post-header {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            position: relative;
        }

        .post-header .profile-pic {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background-color: #363636;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            margin-right: 10px;
        }

        .post-header .profile-pic img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .post-header .profile-pic .initials {
            font-size: 16px;
            font-weight: bold;
            color: #fff;
        }

        .post-header .username {
            font-weight: bold;
            color: #f5f5f5;
            font-size: 15px;
            display: flex;
            align-items: center;
            flex-wrap: wrap; /* Allow wrapping for long usernames/collab text */
        }

        .post-header .username .verified-badge {
            width: 14px;
            height: 14px;
            margin-left: 5px;
        }
        
        /* NEW: Collab Text Style */
        .post-header .collab-text {
            font-size: 13px;
            color: #8e8e8e;
            margin-left: 5px;
        }

        .post-image {
            width: 100%;
            max-height: 500px;
            object-fit: contain;
            display: block;
            background-color: #000;
        }

        .post-actions {
            padding: 10px 15px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .post-actions .action-icon {
            font-size: 24px;
            color: #f5f5f5;
            cursor: pointer;
            transition: opacity 0.2s ease;
        }

        .post-actions .action-icon:hover {
            opacity: 0.7;
        }

        .post-actions .action-icon.liked {
            color: #ed4956;
        }

        .post-likes-comments {
            padding: 0 15px 10px;
            font-size: 14px;
            color: #f5f5f5;
            font-weight: bold;
            display: flex;
            gap: 15px;
        }

        .post-likes-comments .likes-count,
        .post-likes-comments .comments-count {
            color: #f5f5f5;
        }

        /* --- UPDATED CSS FOR CAPTION WITH USERNAME AND INLINE TEXT --- */
        .post-caption {
            padding: 0 15px 10px;
            font-size: 14px;
            color: #f5f5f5;
            white-space: pre-wrap; /* Preserve formatting for breaks within caption text */
            display: flex; /* Use flexbox to put username and text on same line */
            align-items: baseline; /* Align items at their text baselines */
            flex-wrap: wrap; /* Allow caption text to wrap if it's too long */
        }

        .post-caption .caption-username {
            font-weight: bold;
            color: #f5f5f5;
            margin-right: 5px; /* Space between username and caption text */
            display: inline-flex; /* Use inline-flex to contain the username and badge */
            align-items: center;
            white-space: nowrap; /* Prevent username and badge from wrapping */
        }

        .post-caption .caption-username .verified-badge {
            width: 14px;
            height: 14px;
            margin-left: 5px;
            vertical-align: middle;
        }

        .post-caption .caption-text {
            /* No specific styling needed unless you want it different from default */
            flex-grow: 1; /* Allows caption text to take up remaining space */
        }
        /* --- END UPDATED CSS FOR CAPTION --- */

        .post-timestamp {
            padding: 0 15px 12px;
            font-size: 12px;
            color: #8e8e8e;
        }

        .no-posts-message {
            text-align: center;
            padding: 30px 0;
            color: #8e8e8e;
            font-size: 16px;
            display: none; /* Initially hidden, shown by JS if no posts */
        }

        /* Post Options (Three Dots Menu) */
        .post-options {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 20px;
            color: #8e8e8e;
            cursor: pointer;
        }

        .post-options-menu {
            position: absolute;
            top: 40px;
            right: 10px;
            background-color: #262626;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
            z-index: 10;
            overflow: hidden;
            display: none;
        }

        .post-options-menu button {
            display: block;
            width: 100%;
            padding: 10px 20px;
            background-color: transparent;
            border: none;
            color: #f5f5f5;
            font-size: 14px;
            text-align: left;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .post-options-menu button:hover {
            background-color: #363636;
        }

        .post-options-menu button.delete {
            color: #ed4956;
            font-weight: bold;
        }

        /* Footer Navigation */
        .footer {
            background-color: #1a1a1a;
            border-top: 1px solid #262626;
            padding: 10px 0;
            display: flex;
            justify-content: space-around;
            align-items: center;
            position: sticky;
            bottom: 0;
            width: 100%;
            z-index: 1000;
        }

        .footer .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            color: #f5f5f5;
            font-size: 22px;
            transition: color 0.2s ease;
            flex-basis: 20%;
            text-align: center;
        }

        .footer .nav-item i {
            margin-bottom: 3px;
        }

        /* Profile picture in footer */
        .footer .profile-circle {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background-color: #b3b3b3;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 16px;
            font-weight: bold;
            color: #fff;
            overflow: hidden;
            margin-bottom: 3px;
            border: 2px solid transparent;
        }

        .footer .profile-circle.has-image {
            border-color: #f5f5f5;
        }

        .footer .profile-circle img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .footer .nav-item.active {
            color: #0095f6;
        }

        .footer .nav-item:hover {
            color: #8e8e8e;
        }

        .footer .nav-item.active .profile-circle {
            border-color: #0095f6;
        }

        /* Responsive Adjustments */
        @media (max-width: 768px) {
            .header {
                padding: 10px 15px;
            }
            .header .username-display {
                font-size: 18px;
            }
            .header .menu-icon {
                font-size: 20px;
            }
            .profile-picture-container {
                width: 100px;
                height: 100px;
            }
            .profile-picture-container .initials {
                font-size: 40px;
            }
            .stats-section {
                margin-top: 15px;
            }
            .stat-item .count {
                font-size: 16px;
            }
            .stat-item .label {
                font-size: 12px;
            }
            .user-posts-section {
                margin-top: 20px;
                padding-top: 15px;
            }
            .user-posts-section h3 {
                font-size: 18px;
            }
            .post-card {
                margin-bottom: 15px;
            }
            .post-header {
                padding: 10px 12px;
            }
            .post-header .profile-pic {
                width: 28px;
                height: 28px;
            }
            .post-header .profile-pic .initials {
                font-size: 14px;
            }
            .post-header .username {
                font-size: 14px;
            }
            .post-actions {
                font-size: 22px;
                padding: 8px 12px;
                gap: 12px;
            }
            .post-likes-comments {
                font-size: 13px;
                padding: 0 12px 8px;
                gap: 12px;
            }
            /* Adjusted for new caption structure */
            .post-caption {
                font-size: 13px;
                padding: 0 12px 8px; /* Adjusted padding */
            }
            .post-caption .caption-username {
                font-size: 13px; /* Ensure consistency */
            }
            .post-caption .caption-username .verified-badge {
                width: 12px; /* Smaller badge for smaller screens */
                height: 12px;
            }
            /* End adjusted for new caption structure */
            .post-timestamp {
                font-size: 11px;
            }

            /* Responsive for Menu */
            .menu-content {
                width: 200px; /* Smaller menu on smaller screens */
                padding: 15px;
            }
            .menu-item {
                padding: 12px 8px;
                font-size: 15px;
            }
        }

        @media (max-width: 480px) {
            .header {
                padding: 8px 12px;
            }
            .header .username-display {
                font-size: 16px;
            }
            .profile-section {
                padding: 15px;
                gap: 15px;
            }
            .profile-picture-container {
                width: 80px;
                height: 80px;
            }
            .profile-picture-container .initials {
                font-size: 30px;
            }
            .stats-section {
                margin-top: 10px;
                width: 100%;
                justify-content: space-between;
            }
            .stat-item .count {
                font-size: 15px;
            }
            .stat-item .label {
                font-size: 11px;
            }
            .user-posts-section {
                margin-top: 15px;
                padding-top: 10px;
            }
            .user-posts-section h3 {
                font-size: 16px;
            }
            .post-card {
                margin-bottom: 10px;
            }
            .post-header {
                padding: 8px 10px;
            }
            .post-header .profile-pic {
                width: 26px;
                height: 26px;
            }
            .post-header .profile-pic .initials {
                font-size: 12px;
            }
            .post-header .username {
                font-size: 13px;
            }
            .post-actions {
                font-size: 20px;
                gap: 10px;
                padding: 6px 10px;
            }
            .post-likes-comments {
                font-size: 12px;
                padding: 0 10px 6px;
                gap: 10px;
            }
            /* Adjusted for new caption structure */
            .post-caption {
                font-size: 12px;
                padding: 0 10px 6px;
            }
            .post-caption .caption-username {
                font-size: 12px;
            }
            .post-caption .caption-username .verified-badge {
                width: 10px;
                height: 10px;
            }
            /* End adjusted for new caption structure */
            .post-timestamp {
                font-size: 10px;
                padding: 0 10px 10px;
            }

            /* Responsive for Menu */
            .menu-content {
                width: 180px; /* Even smaller menu on very small screens */
                padding: 10px;
            }
            .menu-item {
                padding: 10px 6px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="left-section">
            <span class="username-display" id="currentUsername">Loading...</span>
            <span id="verifiedBadgePlaceholder"></span>
        </div>
        <i class="fas fa-bars menu-icon" id="menuIcon"></i>
    </div>

    <div class="menu-overlay" id="menuOverlay">
        <div class="menu-content" id="menuContent">
            <div class="menu-header">
                <i class="fas fa-times close-icon" id="closeMenuIcon"></i>
            </div>
            <button class="menu-item" id="getVerifiedBtn">Get Verified</button>
            <button class="menu-item" id="logoutBtn">Logout</button>
        </div>
    </div>
    <div class="main-content">
        <div class="profile-section">
            <input type="file" id="profilePictureInput" accept="image/*" style="display: none;">
            <div class="profile-picture-container editable" id="profilePictureContainer">
                <span class="initials" id="profileInitials"></span>
                <img id="profileImage" src="" alt="Profile Picture" style="display: none;">
            </div>

            <div class="bio-section">
                <p class="bio-text" id="bioText"></p>
            </div>

            <div class="stats-section">
                <div class="stat-item">
                    <span class="count" id="postsCount">0</span>
                    <span class="label">Posts</span>
                </div>
                <div class="stat-item">
                    <span class="count" id="followersCount">0</span>
                    <span class="label">Followers</span>
                </div>
                <div class="stat-item">
                    <span class="count" id="followingCount">0</span>
                    <span class="label">Following</span>
                </div>
            </div>

            <div class="profile-actions">
                <button id="editProfileBtn">Edit Profile</button>
            </div>
        </div>

        <div class="user-posts-section">
            <h3>My Posts</h3>
            <div id="postsGrid">
                <p class="no-posts-message" id="noPostsMessage">No posts yet.</p>
            </div>
        </div>
    </div>

    <div class="footer">
        <a href="home.html" class="nav-item" id="homeLink">
            <i class="fas fa-home"></i>
        </a>
        <a href="search.html" class="nav-item" id="searchLink">
            <i class="fas fa-search"></i>
        </a>
        <a href="create.html" class="nav-item" id="createPostLink">
            <i class="fas fa-plus-square"></i>
        </a>
        <a href="notifications.html" class="nav-item" id="notificationsLink">
            <i class="fas fa-heart"></i>
        </a>
        <a href="profile.html" class="nav-item active" id="profileLink">
            <div class="profile-circle" id="footerProfileCircle">
            </div>
        </a>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-storage-compat.js"></script>

    <script>
        // Your Firebase project configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAdu3d0_qEDZaXkBkJAO0VY0htme6_EMyM",
            authDomain: "bluegram-27a79.firebaseapp.com",
            databaseURL: "https://bluegram-27a79-default-rtdb.firebaseio.com",
            projectId: "bluegram-27a79",
            storageBucket: "bluegram-27a79.firebasestorage.app",
            messagingSenderId: "780485443121",
            appId: "1:780485443121:web:f7469d2264293fcbdf5f10",
            measurementId: "G-YF5S9HK2Q5"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();

        // DOM Elements
        const currentUsername = document.getElementById('currentUsername');
        const verifiedBadgePlaceholder = document.getElementById('verifiedBadgePlaceholder');
        const profilePictureContainer = document.getElementById('profilePictureContainer');
        const profilePictureInput = document.getElementById('profilePictureInput');
        const profileInitials = document.getElementById('profileInitials');
        const profileImage = document.getElementById('profileImage');
        const bioText = document.getElementById('bioText');
        const postsCountSpan = document.getElementById('postsCount');
        const followersCountSpan = document.getElementById('followersCount');
        const followingCountSpan = document.getElementById('followingCount');
        const editProfileBtn = document.getElementById('editProfileBtn');
        const postsGrid = document.getElementById('postsGrid');
        const noPostsMessage = document.getElementById('noPostsMessage');
        const menuIcon = document.getElementById('menuIcon');
        const footerProfileCircle = document.getElementById('footerProfileCircle');

        // NEW: Menu Elements
        const menuOverlay = document.getElementById('menuOverlay');
        const menuContent = document.getElementById('menuContent');
        const closeMenuIcon = document.getElementById('closeMenuIcon');
        const getVerifiedBtn = document.getElementById('getVerifiedBtn');
        const logoutBtn = document.getElementById('logoutBtn');


        let currentUserId = null;
        let currentUserData = null; // Store user data globally

        // SVG for the verified badge
        const verifiedSVG = `<svg class="verified-badge" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" viewBox="0 0 256 256" xml:space="preserve">
            <g style="stroke: none; stroke-width: 0; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: none; fill-rule: nonzero; opacity: 1;" transform="translate(1.4065934065934016 1.4065934065934016) scale(2.81 2.81)">
                <polygon points="45,6.18 57.06,0 64.41,11.38 77.94,12.06 78.62,25.59 90,32.94 83.82,45 90,57.06 78.62,64.41 77.94,77.94 64.41,78.62 57.06,90 45,83.82 32.94,90 25.59,78.62 12.06,77.94 11.38,64.41 0,57.06 6.18,45 0,32.94 11.38,25.59 12.06,12.06 25.59,11.38 32.94,0 " style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; fill: rgb(0,150,241); fill-rule: nonzero; opacity: 1;" transform="  matrix(1 0 0 1 0 0) "/>
                <polygon points="40.16,58.47 26.24,45.08 29.7,41.48 40.15,51.52 61.22,31.08 64.7,34.67 " style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; fill: rgb(255,255,255); fill-rule: nonzero; opacity: 1;" transform="  matrix(1 0 0 1 0 0) "/>
            </g>
        </svg>`;

        // Function to update the footer profile picture
        function updateFooterProfilePicture(profilePictureUrl, username) {
            footerProfileCircle.innerHTML = '';
            footerProfileCircle.classList.remove('has-image');
            
            if (profilePictureUrl) {
                const img = document.createElement('img');
                img.src = profilePictureUrl;
                img.alt = 'Profile Picture';
                footerProfileCircle.appendChild(img);
                footerProfileCircle.classList.add('has-image');
            } else {
                const firstLetter = (username && username.length > 0) ? username.charAt(0).toUpperCase() : 'P';
                footerProfileCircle.textContent = firstLetter;
                footerProfileCircle.classList.remove('has-image');
            }
        }


        // Authentication state observer
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUserId = user.uid;

                // Listen for real-time updates to the current user's document
                db.collection('users').doc(currentUserId).onSnapshot(async (doc) => {
                    if (doc.exists) {
                        currentUserData = doc.data();
                        console.log("Current user data updated:", currentUserData); // Debugging
                        displayUserProfile(currentUserData);
                        updateFooterProfilePicture(currentUserData.profilePictureUrl, currentUserData.username);
                    } else {
                        console.log("User document does not exist for ID:", currentUserId);
                        // If user doc doesn't exist, create it with basic info
                        await db.collection('users').doc(currentUserId).set({
                            username: user.displayName || 'User',
                            email: user.email,
                            profilePictureUrl: user.photoURL || '',
                            bio: '',
                            isVerified: false,
                            postsCount: 0,
                            followersCount: 0, // Initialize followers count
                            followingCount: 0, // Initialize following count
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        }, { merge: true });
                        console.log("New user document created.");
                    }
                }, (error) => {
                    console.error("Error fetching user document in real-time:", error);
                });

                listenForUserPostCount(); // Start listening for post count changes
                loadUserPosts(); // Initial load of posts
            } else {
                console.log('No user logged in, redirecting to index.html');
                window.location.href = 'index.html';
            }
        });

        // --- NEW: Function to listen for real-time post count updates ---
        async function listenForUserPostCount() {
            if (!currentUserId) return;

            // This approach is more complex than a single count query because Firestore
            // doesn't have a direct "OR" query across different fields for counting.
            // We need to fetch both sets and then deduplicate to get the total count.
            // This is efficient enough for count updates as it's not rebuilding the UI.

            // Listen to posts where currentUserId is the author
            db.collection('posts')
                .where('userId', '==', currentUserId)
                .onSnapshot(async (authorSnapshot) => {
                    const authorPostIds = new Set(authorSnapshot.docs.map(doc => doc.id));

                    // Listen to posts where currentUserId is a collaborator
                    db.collection('posts')
                        .where('collaborators', 'array-contains', currentUserId)
                        .onSnapshot((collaboratorSnapshot) => {
                            let totalCount = authorPostIds.size;
                            collaboratorSnapshot.docs.forEach(doc => {
                                if (!authorPostIds.has(doc.id)) { // Add if not already counted as an author post
                                    totalCount++;
                                }
                            });
                            postsCountSpan.textContent = totalCount;
                            
                            // Also ensure the "No posts yet." message is updated correctly
                            if (totalCount === 0) {
                                noPostsMessage.style.display = 'block';
                                if (!postsGrid.contains(noPostsMessage)) { // Ensure it's only appended once
                                    postsGrid.appendChild(noPostsMessage);
                                }
                            } else {
                                noPostsMessage.style.display = 'none';
                            }
                        }, (error) => {
                            console.error("Error listening for collaborator post count:", error);
                        });
                }, (error) => {
                    console.error("Error listening for author post count:", error);
                });
        }
        // --- END NEW FUNCTION ---


        // Display user profile data
        function displayUserProfile(userData) {
            currentUsername.textContent = userData.username || 'User';
            if (userData.isVerified) {
                verifiedBadgePlaceholder.innerHTML = verifiedSVG;
            } else {
                verifiedBadgePlaceholder.innerHTML = '';
            }

            // Profile Picture
            if (userData.profilePictureUrl) {
                profileImage.src = userData.profilePictureUrl;
                profileImage.style.display = 'block';
                profileInitials.style.display = 'none';
            } else {
                profileImage.style.display = 'none';
                profileInitials.style.display = 'flex';
                profileInitials.textContent = (userData.username && userData.username.length > 0) ? userData.username.charAt(0).toUpperCase() : 'P';
            }

            // Bio
            const bioContent = userData.bio || '';
            bioText.textContent = bioContent || 'No bio yet. Tap "Edit Profile" to add one.';
            if (bioContent === '') {
                bioText.style.color = '#8e8e8e';
            } else {
                bioText.style.color = '#f5f5f5';
            }

            // Counts (Now updated in real-time by onSnapshot for entire doc)
            followersCountSpan.textContent = userData.followersCount || 0;
            followingCountSpan.textContent = userData.followingCount || 0;
            // postsCountSpan.textContent is handled by listenForUserPostCount
        }

        // Handle profile picture upload
        profilePictureContainer.addEventListener('click', () => {
            profilePictureInput.click();
        });

        profilePictureInput.addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (!file) return;

            if (!currentUserId) {
                alert('You must be logged in to upload a profile picture.');
                return;
            }

            const storageRef = storage.ref(`profile_pictures/${currentUserId}/${file.name}`);
            try {
                const snapshot = await storageRef.put(file);
                const downloadURL = await snapshot.ref.getDownloadURL();

                await db.collection('users').doc(currentUserId).update({
                    profilePictureUrl: downloadURL
                });
                alert('Profile picture updated successfully!');
            } catch (error) {
                console.error("Error uploading profile picture:", error);
                alert("Failed to upload profile picture.");
            }
        });

        // Redirect to edit profile page
        editProfileBtn.addEventListener('click', () => {
            window.location.href = 'edit_profile.html';
        });

        // Helper to format Firestore Timestamps
        function formatTimestamp(timestamp) {
            if (!timestamp || !timestamp.toDate) {
                return 'N/A';
            }
            const date = timestamp.toDate();
            const now = new Date();
            const diffMs = now.getTime() - date.getTime();
            const diffSec = Math.round(diffMs / 1000);
            const diffMin = Math.round(diffSec / 60);
            const diffHrs = Math.round(diffMin / 60);
            const diffDays = Math.round(diffHrs / 24);

            if (diffSec < 60) return `${diffSec}s ago`;
            if (diffMin < 60) return `${diffMin}m ago`;
            if (diffHrs < 24) return `${diffHrs}h ago`;
            if (diffDays < 7) return `${diffDays}d ago`;
            if (diffDays < 30) return `${Math.round(diffDays / 7)}w ago`;
            return date.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
        }

        // Load posts by the current user and where they are a collaborator
        async function loadUserPosts() {
            if (!currentUserId) return;

            postsGrid.innerHTML = ''; // Clear existing posts

            // 1. Fetch posts where current user is the primary author
            const authorPostsSnapshot = await db.collection('posts')
                .where('userId', '==', currentUserId)
                .orderBy('timestamp', 'desc')
                .get();

            // 2. Fetch posts where current user is a collaborator
            const collaboratorPostsSnapshot = await db.collection('posts')
                .where('collaborators', 'array-contains', currentUserId)
                .orderBy('timestamp', 'desc')
                .get();

            // Combine and deduplicate posts
            const combinedPosts = new Map(); // Use a Map to store unique posts by ID

            authorPostsSnapshot.docs.forEach(doc => {
                combinedPosts.set(doc.id, { id: doc.id, ...doc.data() });
            });

            collaboratorPostsSnapshot.docs.forEach(doc => {
                // Only add if not already present (i.e., not an author post already)
                if (!combinedPosts.has(doc.id)) {
                    combinedPosts.set(doc.id, { id: doc.id, ...doc.data() });
                }
            });

            // Convert map values to an array and sort by timestamp (descending)
            const sortedPosts = Array.from(combinedPosts.values()).sort((a, b) => {
                const timestampA = a.timestamp && a.timestamp.toDate ? a.timestamp.toDate().getTime() : 0;
                const timestampB = b.timestamp && b.timestamp.toDate ? b.timestamp.toDate().getTime() : 0;
                return timestampB - timestampA;
            });

            if (sortedPosts.length === 0) {
                // Visibility of noPostsMessage is now handled by listenForUserPostCount
                return;
            }

            const postPromises = sortedPosts.map(async post => {
                const postId = post.id;
                const postCard = document.createElement('div');
                postCard.classList.add('post-card');
                postCard.setAttribute('data-post-id', postId);

                const formattedTime = formatTimestamp(post.timestamp);
                const numLikes = post.likes || 0;
                const likedBy = post.likedBy || [];
                const hasLiked = likedBy.includes(currentUserId);

                // Determine display username and profile pic for the post header
                let displayUsername = currentUserData.username;
                let displayProfilePicUrl = currentUserData.profilePictureUrl;
                let displayIsVerified = currentUserData.isVerified;

                let collabText = '';

                if (post.collaborators && post.collaborators.length > 0) {
                    // Filter out the current user (if they are the author or a collaborator)
                    const otherCollaboratorIds = post.collaborators.filter(id => id !== currentUserId);

                    if (post.userId === currentUserId) { // Current user is the author
                        if (otherCollaboratorIds.length > 0) {
                            const collaboratorUsernames = [];
                            for (const collabId of otherCollaboratorIds) {
                                const collabUserDoc = await db.collection('users').doc(collabId).get();
                                if (collabUserDoc.exists) {
                                    collaboratorUsernames.push(collabUserDoc.data().username);
                                }
                            }
                            if (collaboratorUsernames.length > 0) {
                                collabText = `<span class="collab-text"> &bull; with ${collaboratorUsernames.join(', ')}</span>`;
                            }
                        }
                    } else if (post.collaborators.includes(currentUserId)) { // Current user is a collaborator, but not the author
                        const mainAuthorDoc = await db.collection('users').doc(post.userId).get();
                        if (mainAuthorDoc.exists) {
                            const mainAuthorData = mainAuthorDoc.data();
                            displayUsername = mainAuthorData.username || 'Unknown User';
                            displayProfilePicUrl = mainAuthorData.profilePictureUrl || '';
                            displayIsVerified = mainAuthorData.isVerified || false;
                        }

                        collabText = `<span class="collab-text"> &bull; with you`;
                        if (otherCollaboratorIds.length > 0) {
                             const collaboratorUsernames = [];
                            for (const collabId of otherCollaboratorIds) {
                                const collabUserDoc = await db.collection('users').doc(collabId).get();
                                if (collabUserDoc.exists) {
                                    collaboratorUsernames.push(collabUserDoc.data().username);
                                }
                            }
                            if (collaboratorUsernames.length > 0) {
                                collabText += `, ${collaboratorUsernames.join(', ')}`;
                            }
                        }
                        collabText += `</span>`;
                    }
                }

                postCard.innerHTML = `
                    <div class="post-header">
                        <div class="profile-pic">
                            ${displayProfilePicUrl ? `<img src="${displayProfilePicUrl}" alt="${displayUsername}'s profile pic">` : `<span class="initials">${displayUsername.charAt(0).toUpperCase()}</span>`}
                        </div>
                        <span class="username">
                            ${displayUsername}
                            ${displayIsVerified ? verifiedSVG : ''}
                            ${collabText}
                        </span>
                        <div class="post-options" data-postid="${postId}">
                            <i class="fas fa-ellipsis-h"></i>
                            <div class="post-options-menu">
                                <button class="delete" data-postid="${postId}">Delete</button>
                            </div>
                        </div>
                    </div>
                    <img src="${post.imageUrl}" alt="Post Image" class="post-image">
                    <div class="post-actions">
                        <i class="${hasLiked ? 'fas' : 'far'} fa-heart action-icon ${hasLiked ? 'liked' : ''}" data-postid="${postId}"></i>
                        <i class="far fa-comment action-icon" data-postid="${postId}"></i>
                    </div>
                    <div class="post-likes-comments">
                        <span class="likes-count">${numLikes} likes</span>
                    </div>
                    <div class="post-caption">
                        <span class="caption-username">
                            ${displayUsername}
                            ${displayIsVerified ? verifiedSVG : ''}
                        </span>
                        <span class="caption-text">${post.caption}</span>
                    </div>
                    <div class="post-timestamp">${formattedTime}</div>
                `;
                return postCard;
            });

            const postCards = await Promise.all(postPromises); // Wait for all post cards to be built
            postCards.forEach(card => {
                postsGrid.appendChild(card);

                // Add click listener to the entire post card for single post view
                card.addEventListener('click', (event) => {
                    // Prevent propagation if a button/icon inside the card was clicked
                    if (!event.target.closest('.action-icon') && !event.target.closest('.post-options')) {
                        viewSinglePost(card.getAttribute('data-post-id'));
                    }
                });

                // Event listener for post options (three dots menu)
                const postOptions = card.querySelector('.post-options');
                const postOptionsMenu = card.querySelector('.post-options-menu');
                if (postOptions && postOptionsMenu) {
                    postOptions.addEventListener('click', (event) => {
                        event.stopPropagation(); // Prevent card click
                        // Close other open menus
                        document.querySelectorAll('.post-options-menu').forEach(menu => {
                            if (menu !== postOptionsMenu) {
                                menu.style.display = 'none';
                            }
                        });
                        postOptionsMenu.style.display = postOptionsMenu.style.display === 'block' ? 'none' : 'block';
                    });

                    // Close menu when clicking outside
                    document.addEventListener('click', (event) => {
                        if (!postOptions.contains(event.target) && !postOptionsMenu.contains(event.target)) {
                            postOptionsMenu.style.display = 'none';
                        }
                    });
                }

                // Event listener for delete button
                const deleteButton = card.querySelector('.post-options-menu .delete');
                if (deleteButton) {
                    deleteButton.addEventListener('click', async (event) => {
                        event.stopPropagation(); // Prevent options menu from closing immediately
                        const postIdToDelete = deleteButton.dataset.postid;
                        if (confirm('Are you sure you want to delete this post?')) {
                            await deletePost(postIdToDelete);
                            postOptionsMenu.style.display = 'none'; // Hide menu after action
                        }
                    });
                }

                // Add event listener for the comment icon specifically
                const commentIcon = card.querySelector('.post-actions .fa-comment');
                if (commentIcon) {
                    commentIcon.addEventListener('click', (event) => {
                        event.stopPropagation();
                        const postId = commentIcon.dataset.postid;
                        window.location.href = `comments.html?postId=${postId}`;
                    });
                }

                // Add event listener for the like icon specifically
                const likeIcon = card.querySelector('.post-actions .fa-heart');
                if (likeIcon) {
                    likeIcon.addEventListener('click', async (event) => {
                        event.stopPropagation();
                        const postId = likeIcon.dataset.postid;
                        const postRef = db.collection('posts').doc(postId);
                        const currentLikesSpan = card.querySelector('.likes-count');
                        let currentLikes = parseInt(currentLikesSpan.textContent.split(' ')[0]);

                        try {
                            if (likeIcon.classList.contains('liked')) {
                                // Unlike
                                await postRef.update({
                                    likes: firebase.firestore.FieldValue.increment(-1),
                                    likedBy: firebase.firestore.FieldValue.arrayRemove(currentUserId)
                                });
                                currentLikes--;
                                likeIcon.classList.remove('liked', 'fas');
                                likeIcon.classList.add('far');
                                console.log(`Post ${postId} unliked!`);
                            } else {
                                // Like
                                await postRef.update({
                                    likes: firebase.firestore.FieldValue.increment(1),
                                    likedBy: firebase.firestore.FieldValue.arrayUnion(currentUserId)
                                });
                                currentLikes++;
                                likeIcon.classList.add('liked', 'fas');
                                likeIcon.classList.remove('far');
                                console.log(`Post ${postId} liked!`);

                                // Add notification for the post owner
                                const postOwnerId = post.userId; 
                                if (currentUserId !== postOwnerId) { 
                                    await db.collection('notifications').add({
                                        type: 'like',
                                        actorUserId: currentUserId,
                                        targetUserId: postOwnerId, 
                                        postId: postId, 
                                        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                                        read: false
                                    });
                                }
                            }
                            currentLikesSpan.textContent = `${currentLikes} likes`;
                        } catch (error) {
                            console.error("Error updating like:", error);
                        }
                    });
                }
            });
            // postsCountSpan.textContent is handled by listenForUserPostCount
        }


        // Function to delete a post
        async function deletePost(postId) {
            if (!currentUserId) {
                alert('You must be logged in to delete posts.');
                return;
            }

            try {
                const postRef = db.collection('posts').doc(postId);
                const postDoc = await postRef.get();

                if (!postDoc.exists) {
                    alert('Post not found.');
                    return;
                }

                const postData = postDoc.data();
                if (postData.userId !== currentUserId) {
                    alert('You can only delete your own posts.');
                    return;
                }

                // Delete image from storage
                if (postData.imageUrl) {
                    const imageRef = storage.refFromURL(postData.imageUrl);
                    await imageRef.delete();
                    console.log('Post image deleted from storage.');
                }

                // Delete post document from Firestore
                await postRef.delete();
                console.log('Post deleted from Firestore.');

                // Decrement post count for the user (handled by listenForUserPostCount now)
                // await db.collection('users').doc(currentUserId).update({
                //     postsCount: firebase.firestore.FieldValue.increment(-1)
                // });

                alert('Post deleted successfully!');
                // Reload posts to update the grid
                loadUserPosts(); // Reload all posts after deletion
            } catch (error) {
                console.error("Error deleting post:", error);
                alert("Failed to delete post.");
            }
        }

        // View single post function
        function viewSinglePost(postId) {
            // Redirect to home.html with a query parameter for the specific post
            window.location.href = `home.html?postId=${postId}`;
        }


        // Initial setup for the footer profile circle
        updateFooterProfilePicture(null, 'P');
        
        // Footer navigation logic
        document.addEventListener('DOMContentLoaded', () => {
            const navItems = document.querySelectorAll('.footer .nav-item');
            const homeLink = document.getElementById('homeLink');
            const searchLink = document.getElementById('searchLink');
            const createPostLink = document.getElementById('createPostLink');
            const notificationsLink = document.getElementById('notificationsLink');
            const profileLink = document.getElementById('profileLink');

            function setActiveLink(clickedLink) {
                navItems.forEach(item => {
                    item.classList.remove('active');
                    const profileCircle = item.querySelector('.profile-circle');
                    if (profileCircle) {
                        profileCircle.style.borderColor = 'transparent';
                    }
                });
                clickedLink.classList.add('active');
                const profileCircle = clickedLink.querySelector('.profile-circle');
                if (profileCircle && profileCircle.classList.contains('has-image')) {
                    profileCircle.style.borderColor = '#0095f6';
                } else if (profileCircle) {
                    profileCircle.style.borderColor = 'transparent';
                }
            }

            const currentPath = window.location.pathname.split('/').pop();
            if (currentPath === 'home.html') {
                setActiveLink(homeLink);
            } else if (currentPath === 'search.html') {
                setActiveLink(searchLink);
            } else if (currentPath === 'create.html') {
                setActiveLink(createPostLink);
            } else if (currentPath === 'notifications.html') {
                setActiveLink(notificationsLink);
            } else if (currentPath === 'profile.html') {
                setActiveLink(profileLink);
            }

            navItems.forEach(item => {
                item.addEventListener('click', function(event) {
                    // if (this.getAttribute('href') === '#' || this.classList.contains('active')) {
                    //     event.preventDefault(); 
                    // }
                    setActiveLink(this);
                });
            });

            // NEW: Menu event listeners
            menuIcon.addEventListener('click', () => {
                menuOverlay.classList.add('active');
            });

            closeMenuIcon.addEventListener('click', () => {
                menuOverlay.classList.remove('active');
            });

            menuOverlay.addEventListener('click', (event) => {
                if (event.target === menuOverlay) { // Only close if clicked on the overlay itself, not the menu content
                    menuOverlay.classList.remove('active');
                }
            });

            getVerifiedBtn.addEventListener('click', () => {
                window.location.href = 'verification.html';
                menuOverlay.classList.remove('active'); // Close menu after redirect
            });

            logoutBtn.addEventListener('click', async () => {
                try {
                    await auth.signOut();
                    alert('Logged out successfully!');
                    window.location.href = 'index.html'; // Redirect to login page after logout
                } catch (error) {
                    console.error("Error logging out:", error);
                    alert("Failed to log out.");
                }
            });
        });
    </script>
</body>
</html>
