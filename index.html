<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bluenote - Login/Signup</title>
    <style>
        /* Basic CSS for responsiveness and styling */
        body {
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #fafafa;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
            overflow: hidden; /* Prevent scroll on loading */
        }

        .container {
            background-color: #fff;
            border: 1px solid #dbdbdb;
            border-radius: 5px;
            padding: 40px;
            text-align: center;
            width: 100%;
            max-width: 350px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
        }

        h2 {
            margin-bottom: 25px;
            color: #262626;
            font-size: 28px;
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 15px;
        }

        input[type="email"],
        input[type="password"],
        input[type="text"] {
            width: calc(100% - 20px);
            padding: 10px;
            margin: 0 auto;
            border: 1px solid #dbdbdb;
            border-radius: 3px;
            box-sizing: border-box;
            font-size: 14px;
        }

        button {
            width: 100%;
            padding: 10px 0;
            background-color: #0095f6;
            color: #fff;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        button:hover {
            background-color: #007acb;
        }

        button:disabled {
            background-color: #a8d5f7;
            cursor: not-allowed;
        }

        .toggle-form-link {
            margin-top: 20px;
            font-size: 14px;
            color: #262626;
        }

        .toggle-form-link a {
            color: #0095f6;
            text-decoration: none;
            font-weight: bold;
        }

        .error-message {
            color: #ed4956;
            margin-top: 10px;
            font-size: 13px;
            display: none; /* Hidden by default, show with JavaScript */
        }

        /* Responsive adjustments */
        @media (max-width: 400px) {
            .container {
                padding: 30px 20px;
                margin: 10px;
            }
            h2 {
                font-size: 24px;
            }
        }

        /* Ban Modal Styles */
        .ban-modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top of everything */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.6); /* Black w/ opacity */
            justify-content: center;
            align-items: center;
        }

        .ban-modal-content {
            background-color: #fff;
            margin: auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 400px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            position: relative;
        }

        .ban-modal-content h3 {
            color: #ed4956;
            margin-bottom: 15px;
        }

        .ban-modal-content p {
            margin-bottom: 10px;
            line-height: 1.5;
            color: #333;
        }

        .ban-modal-close {
            color: #aaa;
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .ban-modal-close:hover,
        .ban-modal-close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        /* Loading Screen Styles */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #fff; /* Or match your app's background */
            display: flex;
            flex-direction: column; /* To stack loader and text */
            justify-content: center;
            align-items: center;
            z-index: 2000; /* Ensure it's on top */
            opacity: 1;
            transition: opacity 0.5s ease-out;
            pointer-events: all; /* Allow interactions while visible */
        }

        .loading-screen.hidden {
            opacity: 0;
            pointer-events: none; /* Disable interactions when hidden */
        }

        .loader {
            border: 8px solid #f3f3f3; /* Light grey */
            border-top: 8px solid #0095f6; /* Blue */
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin-bottom: 15px; /* Space between loader and text */
        }

        .loading-text {
            font-size: 16px;
            color: #555;
            font-weight: bold;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Username Creation Form Styles */
        #username-form {
            display: none; /* Hidden by default */
        }

        #username-form h2 {
            font-size: 24px;
            margin-bottom: 20px;
        }
        #username-form p {
            font-size: 14px;
            color: #666;
            margin-bottom: 20px;
        }

        /* Maintenance Modal Styles */
        .maintenance-modal {
            display: none; /* Hidden by default */
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            justify-content: center;
            align-items: center;
        }

        .maintenance-modal-content {
            background-color: #fff;
            padding: 30px;
            border-radius: 10px;
            max-width: 500px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            position: relative;
        }

        .maintenance-modal-content h3 {
            color: #ffc107; /* Warning yellow */
            margin-bottom: 15px;
            font-size: 24px;
        }

        .maintenance-modal-content p {
            color: #333;
            margin-bottom: 10px;
            line-height: 1.6;
        }

        .maintenance-modal-content .status-message {
            font-weight: bold;
            color: #555;
        }

        /* Update Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.75);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000; /* Above all other content */
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }

        .update-modal {
            background-color: #1a1a1a;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.6);
            width: 90%;
            max-width: 450px;
            text-align: center;
            position: relative;
            animation: fadeIn 0.3s ease-out;
            color: #f5f5f5;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .update-modal h3 {
            color: #0095f6;
            font-size: 26px;
            margin-bottom: 15px;
            font-weight: 700;
        }

        .update-modal p {
            font-size: 15px;
            margin-bottom: 20px;
            line-height: 1.5;
            color: #b3b3b3;
        }

        .update-modal .version-info {
            font-weight: bold;
            color: #f5f5f5;
            margin-bottom: 15px;
            font-size: 16px;
        }

        .update-modal .features-list {
            text-align: left;
            margin-bottom: 25px;
            padding-left: 20px; /* For bullet points */
        }

        .update-modal .features-list li {
            font-size: 14px;
            color: #b3b3b3;
            margin-bottom: 8px;
            list-style-type: disc;
        }

        .update-modal .button-group {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .update-modal button {
            width: 100%;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.1s ease;
        }

        .update-modal button#updateNowBtn {
            background-color: #0095f6;
            color: #fff;
        }

        .update-modal button#updateNowBtn:hover {
            background-color: #007acb;
            transform: translateY(-2px);
        }

        .update-modal button#laterBtn {
            background-color: #363636;
            color: #f5f5f5;
        }

        .update-modal button#laterBtn:hover {
            background-color: #4a4a4a;
            transform: translateY(-2px);
        }

        @media (max-width: 480px) {
            .update-modal {
                padding: 20px;
            }
            .update-modal h3 {
                font-size: 22px;
            }
            .update-modal p,
            .update-modal .version-info,
            .update-modal .features-list li {
                font-size: 13px;
            }
            .update-modal button {
                padding: 10px 15px;
                font-size: 15px;
            }
        }

        .app-version-display {
            margin-top: 20px;
            font-size: 12px;
            color: #888;
        }
    </style>
</head>
<body>

    <div id="loadingScreen" class="loading-screen">
        <div class="loader"></div>
        <div id="loadingText" class="loading-text">Loading...</div>
    </div>

    <div class="container" id="mainContainer">
        <div id="login-form">
            <h2>Log In</h2>
            <div class="form-group">
                <input type="email" id="loginEmail" placeholder="Email" required>
            </div>
            <div class="form-group">
                <input type="password" id="loginPassword" placeholder="Password" required>
            </div>
            <p class="error-message" id="loginErrorMessage"></p>
            <button id="loginBtn">Log In</button>
            <p class="toggle-form-link">Don't have an account? <a href="#" id="showSignup">Sign up</a></p>
        </div>

        <div id="signup-form" style="display: none;">
            <h2>Sign Up</h2>
            <div class="form-group">
                <input type="email" id="signupEmail" placeholder="Email" required>
            </div>
            <div class="form-group">
                <input type="password" id="signupPassword" placeholder="Password" required>
            </div>
            <div class="form-group">
                <input type="password" id="signupConfirmPassword" placeholder="Confirm Password" required>
            </div>
            <p class="error-message" id="signupErrorMessage"></p>
            <button id="signupBtn">Sign Up</button>
            <p class="toggle-form-link">Have an account? <a href="#" id="showLogin">Log in</a></p>
        </div>

        <div id="username-form" style="display: none;">
            <h2>Create Username</h2>
            <p>Choose a unique username for your Bluenote account. You can change this later in your profile settings.</p>
            <div class="form-group">
                <input type="text" id="usernameInput" placeholder="Username" required>
            </div>
            <p class="error-message" id="usernameErrorMessage"></p>
            <button id="createUsernameBtn">Continue</button>
        </div>

        <p class="app-version-display">Version: <span id="currentAppVersion"></span></p>
    </div>

    <div id="banModal" class="ban-modal" style="display: none;">
        <div class="ban-modal-content">
            <span class="ban-modal-close">&times;</span>
            <h3>Account Banned</h3>
            <p id="banReasonDisplay"></p>
            <p id="banEndTimeDisplay"></p>
        </div>
    </div>

    <div id="maintenanceModal" class="maintenance-modal" style="display: none;">
        <div class="maintenance-modal-content">
            <h3>Server Under Maintenance</h3>
            <p id="maintenanceMessage"></p>
            <p class="status-message">Estimated End Time: <span id="maintenanceEndTime"></span></p>
            <p>We apologize for the inconvenience. Please try again later.</p>
        </div>
    </div>

    <div class="modal-overlay" id="updateModalOverlay" style="display: none;">
        <div class="update-modal">
            <h3>Update Bluenote</h3>
            <p id="updateMessageText"></p>
            <p class="version-info">New Version: <span id="updateVersionText"></span></p>
            <h4>New Features:</h4>
            <ul class="features-list" id="newFeaturesList">
                </ul>
            <div class="button-group">
                <button id="updateNowBtn">Update Now</button>
                <button id="laterBtn">Later</button>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-firestore-compat.js"></script>
    <script>
        // Your Firebase project configuration
         const firebaseConfig = {
            apiKey: "AIzaSyAdu3d0_qEDZaXkBkJAO0VY0htme6_EMyM",
            authDomain: "bluegram-27a79.firebaseapp.com",
            databaseURL: "https://bluegram-27a79-default-rtdb.firebaseio.com",
            projectId: "bluegram-27a79",
            storageBucket: "bluegram-27a79.firebasestorage.app",
            messagingSenderId: "780485443121",
            // IMPORTANT: Ensure this appId is correct for YOUR project from Firebase Console
            appId: "1:780485443121:web:f7469d2264293fcbdf5f10", 
            measurementId: "G-YF5S9HK2Q5"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- App Version Configuration ---
        // !!! IMPORTANT: Update this version number when you release a new app version !!!
        const CURRENT_APP_VERSION = "5.0.1"; // <--- Set your current app version here
        // --- End App Version Configuration ---


        // Get references to elements
        const loginForm = document.getElementById('login-form');
        const signupForm = document.getElementById('signup-form');
        const usernameForm = document.getElementById('username-form');
        const mainContainer = document.getElementById('mainContainer');

        const showSignupLink = document.getElementById('showSignup');
        const showLoginLink = document.getElementById('showLogin');

        const loginEmailInput = document.getElementById('loginEmail');
        const loginPasswordInput = document.getElementById('loginPassword');
        const loginBtn = document.getElementById('loginBtn');
        const loginErrorMessage = document.getElementById('loginErrorMessage');

        const signupEmailInput = document.getElementById('signupEmail');
        const signupPasswordInput = document.getElementById('signupPassword');
        const signupConfirmPasswordInput = document.getElementById('signupConfirmPassword');
        const signupBtn = document.getElementById('signupBtn');
        const signupErrorMessage = document.getElementById('signupErrorMessage');

        const usernameInput = document.getElementById('usernameInput');
        const createUsernameBtn = document.getElementById('createUsernameBtn');
        const usernameErrorMessage = document.getElementById('usernameErrorMessage');

        // Ban Modal Elements
        const banModal = document.getElementById('banModal');
        const banReasonDisplay = document.getElementById('banReasonDisplay');
        const banEndTimeDisplay = document.getElementById('banEndTimeDisplay');
        const banModalCloseBtn = document.querySelector('.ban-modal-close');

        // Loading Screen Element
        const loadingScreen = document.getElementById('loadingScreen');
        const loadingText = document.getElementById('loadingText');

        // Maintenance Modal Elements
        const maintenanceModal = document.getElementById('maintenanceModal');
        const maintenanceMessage = document.getElementById('maintenanceMessage');
        const maintenanceEndTime = document.getElementById('maintenanceEndTime');

        // Update Modal DOM elements
        const updateModalOverlay = document.getElementById('updateModalOverlay');
        const updateMessageText = document.getElementById('updateMessageText');
        const updateVersionText = document.getElementById('updateVersionText');
        const newFeaturesList = document.getElementById('newFeaturesList');
        const updateNowBtn = document.getElementById('updateNowBtn');
        const laterBtn = document.getElementById('laterBtn');

        // App Version Display
        const currentAppVersionSpan = document.getElementById('currentAppVersion');


        const LOCAL_STORAGE_LAST_SEEN_UPDATE = 'bluenote_last_seen_update_version'; // Same key as in home.html

        let pendingUserUid = null;
        let isUnderMaintenance = false;
        let authUserPendingCheck = null; // To hold the user object if update is pending

        // Function to show error messages
        function showError(element, message) {
            element.textContent = message;
            element.style.display = 'block';
        }

        // Function to hide error messages
        function hideError(element) {
            element.textContent = '';
            element.style.display = 'none';
        }

        // Function to display the ban popup
        function displayBanPopup(reason, endTime) {
            banReasonDisplay.textContent = `Reason: ${reason}`;
            let timeMessage = '';
            if (endTime) {
                const now = new Date();
                const banEnd = endTime.toDate(); // Convert Firestore Timestamp to Date object
                const diffTime = banEnd.getTime() - now.getTime();
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                const diffMonths = Math.ceil(diffDays / 30); // Approximate months

                if (diffDays <= 0) {
                     timeMessage = 'Your ban has expired. Please try logging in again.';
                } else if (diffDays < 30) {
                    timeMessage = `Ban ends in ${diffDays} day(s).`;
                } else {
                    timeMessage = `Ban ends in approximately ${diffMonths} month(s).`;
                }
                timeMessage += ` (Expires on: ${banEnd.toLocaleString()})`;
            } else {
                timeMessage = 'This ban is permanent.';
            }
            banEndTimeDisplay.textContent = timeMessage;
            banModal.style.display = 'flex'; // Show modal
            mainContainer.style.display = 'none'; // Hide main container behind modal
        }

        // Close ban modal
        banModalCloseBtn.addEventListener('click', () => {
            banModal.style.display = 'none';
            mainContainer.style.display = 'block'; // Show main container again
        });

        // Function to display maintenance popup and disable forms
        function showMaintenanceMode(message, endTime) {
            maintenanceMessage.textContent = message || 'We are performing essential updates to improve your experience.';
            if (endTime) {
                const endDate = endTime.toDate();
                maintenanceEndTime.textContent = endDate.toLocaleString();
            } else {
                maintenanceEndTime.textContent = 'Undetermined (check back later)';
            }
            maintenanceModal.style.display = 'flex';
            mainContainer.style.display = 'none'; // Hide main forms
            // Disable all buttons and inputs
            document.querySelectorAll('button, input').forEach(el => el.disabled = true);
            showSignupLink.style.pointerEvents = 'none'; // Disable link clicks
            showLoginLink.style.pointerEvents = 'none'; // Disable link clicks
            isUnderMaintenance = true; // Set maintenance flag
        }

        // Function to hide maintenance popup and enable forms
        function hideMaintenanceMode() {
            maintenanceModal.style.display = 'none';
            mainContainer.style.display = 'block'; // Show main forms
            // Enable all buttons and inputs
            document.querySelectorAll('button, input').forEach(el => el.disabled = false);
            showSignupLink.style.pointerEvents = 'auto'; // Enable link clicks
            showLoginLink.style.pointerEvents = 'auto'; // Enable link clicks
            isUnderMaintenance = false; // Clear maintenance flag
        }

        // Toggle between login and signup forms
        showSignupLink.addEventListener('click', (e) => {
            e.preventDefault();
            if (isUnderMaintenance) return;
            loginForm.style.display = 'none';
            signupForm.style.display = 'block';
            usernameForm.style.display = 'none';
            hideError(loginErrorMessage);
            hideError(signupErrorMessage);
            hideError(usernameErrorMessage);
        });

        showLoginLink.addEventListener('click', (e) => {
            e.preventDefault();
            if (isUnderMaintenance) return;
            signupForm.style.display = 'none';
            loginForm.style.display = 'block';
            usernameForm.style.display = 'none';
            hideError(loginErrorMessage);
            hideError(signupErrorMessage);
            hideError(usernameErrorMessage);
        });

        // Function to show the username creation form
        function showUsernameForm() {
            loginForm.style.display = 'none';
            signupForm.style.display = 'none';
            usernameForm.style.display = 'block';
            mainContainer.style.transform = 'translateY(0)';
            mainContainer.style.opacity = '1';
        }

        // Function to show the main login/signup forms
        function showAuthForms() {
            loginForm.style.display = 'block'; // Default to login
            signupForm.style.display = 'none';
            usernameForm.style.display = 'none';
            mainContainer.style.transform = 'translateY(0)';
            mainContainer.style.opacity = '1';
        }

        // Hide loading screen
        function hideLoadingScreen() {
            loadingScreen.classList.add('hidden');
            loadingText.textContent = '';
        }

        // Show loading screen
        function showLoadingScreen(message = '') {
            loadingScreen.classList.remove('hidden');
            loadingText.textContent = message;
        }

        // Helper function to compare versions (e.g., "1.0.0" vs "1.0.1")
        function compareVersions(v1, v2) {
            const parts1 = v1.split('.').map(Number);
            const parts2 = v2.split('.').map(Number);

            for (let i = 0; i < Math.max(parts1.length, parts2.length); i++) {
                const p1 = parts1[i] || 0;
                const p2 = parts2[i] || 0;
                if (p1 < p2) return -1; // v1 is older
                if (p1 > p2) return 1;  // v1 is newer
            }
            return 0; // versions are the same
        }

        // --- Firebase Authentication Logic ---

        // Function to check maintenance status first
        async function checkMaintenanceStatus() {
            showLoadingScreen('Checking server status...');
            try {
                const appStatusDoc = await db.collection('app_status').doc('maintenance').get();
                if (appStatusDoc.exists) {
                    const maintenanceData = appStatusDoc.data();
                    if (maintenanceData.isMaintenanceMode) {
                        const maintenanceEndTimeFirestore = maintenanceData.endTime;
                        const now = firebase.firestore.Timestamp.now();

                        if (maintenanceEndTimeFirestore && maintenanceEndTimeFirestore.seconds < now.seconds) {
                            // Maintenance period has expired, update Firestore
                            await db.collection('app_status').doc('maintenance').update({
                                isMaintenanceMode: false,
                                message: firebase.firestore.FieldValue.delete(),
                                endTime: firebase.firestore.FieldValue.delete()
                            });
                            console.log('Maintenance mode expired and updated in Firestore.');
                            hideMaintenanceMode();
                            return false;
                        } else {
                            // Maintenance mode is active and not expired
                            showMaintenanceMode(maintenanceData.message, maintenanceEndTimeFirestore);
                            hideLoadingScreen();
                            return true;
                        }
                    }
                }
                hideMaintenanceMode(); // No maintenance mode active
                return false;
            } catch (error) {
                console.error('Error checking maintenance status:', error.message);
                hideLoadingScreen();
                return false;
            }
        }

        // --- Update Modal Functions ---
        async function checkForAppUpdates() {
            showLoadingScreen('Checking for updates...'); // Update loading text
            try {
                const appUpdateDocRef = db.collection('app_status').doc('app_updates');
                const docSnap = await appUpdateDocRef.get();

                if (docSnap.exists) {
                    const updateData = docSnap.data();
                    const latestVersion = updateData.latestVersion;
                    const updateMessage = updateData.updateMessage;
                    const newFeatures = updateData.newFeatures || [];
                    const updateLink = updateData.updateLink;
                    const forceUpdate = updateData.forceUpdate || false;

                    const lastSeenVersion = localStorage.getItem(LOCAL_STORAGE_LAST_SEEN_UPDATE);

                    // Check if a new version is available
                    if (latestVersion && compareVersions(CURRENT_APP_VERSION, latestVersion) < 0) {
                        // If force update or if the user hasn't seen this specific version yet
                        if (forceUpdate || (lastSeenVersion !== latestVersion)) {
                            // Hide main container and show update modal
                            mainContainer.style.display = 'none';
                            showUpdateModal(latestVersion, updateMessage, newFeatures, updateLink, forceUpdate);
                            return true; // Indicate that an update modal is shown
                        }
                    }
                }
                return false; // No update to show or user already dismissed this version
            } catch (error) {
                console.error("Error checking for app updates:", error);
                return false;
            } finally {
                // Do not hide loading screen here, it will be handled after auth check or update action
            }
        }

        function showUpdateModal(version, message, features, link, force) {
            updateModalOverlay.style.display = 'flex';
            updateMessageText.textContent = message;
            updateVersionText.textContent = version;
            newFeaturesList.innerHTML = '';
            features.forEach(feature => {
                const li = document.createElement('li');
                li.textContent = feature;
                newFeaturesList.appendChild(li);
            });

            // If forced, hide 'Later' button and make 'Update Now' mandatory
            if (force) {
                laterBtn.style.display = 'none';
                updateNowBtn.onclick = () => {
                    showLoadingScreen('Redirecting to update...');
                    window.open(link, '_blank');
                    // For a forced update, after opening the link, the app expects the user to update.
                    // You might consider a small delay and then close the current window/tab or refresh.
                    // For now, it just opens the link.
                    localStorage.setItem(LOCAL_STORAGE_LAST_SEEN_UPDATE, version); // Mark as seen
                };
                // Prevent accidental closing of modal or trying 'Later' via other means
                 updateModalOverlay.addEventListener('click', (e) => {
                    if (e.target === updateModalOverlay) {
                        alert("This is a mandatory update. You must update to continue using Bluenote.");
                        e.stopPropagation(); // Prevent event from bubbling
                    }
                });
            } else {
                laterBtn.style.display = 'block';
                updateNowBtn.onclick = () => {
                    showLoadingScreen('Redirecting to update...');
                    window.open(link, '_blank');
                    localStorage.setItem(LOCAL_STORAGE_LAST_SEEN_UPDATE, version);
                    updateModalOverlay.style.display = 'none';
                    hideLoadingScreen();
                    // Proceed with login check after update action
                    if (authUserPendingCheck) {
                        checkBanStatusAndHandleLogin(authUserPendingCheck);
                        authUserPendingCheck = null; // Clear pending user
                    } else {
                        showAuthForms();
                    }
                };

                laterBtn.onclick = () => {
                    localStorage.setItem(LOCAL_STORAGE_LAST_SEEN_UPDATE, version);
                    updateModalOverlay.style.display = 'none';
                    hideLoadingScreen();
                    // Proceed with login check after 'Later' action
                    if (authUserPendingCheck) {
                        checkBanStatusAndHandleLogin(authUserPendingCheck);
                        authUserPendingCheck = null; // Clear pending user
                    } else {
                        showAuthForms();
                    }
                };
            }
            hideLoadingScreen(); // Hide general loading screen once update modal is visible
        }


        // Function to check ban status and handle login/redirection
        async function checkBanStatusAndHandleLogin(user) {
            showLoadingScreen('Checking login info...');
            if (!user) {
                hideLoadingScreen();
                showAuthForms();
                return;
            }

            const userDocRef = db.collection('users').doc(user.uid);
            try {
                const doc = await userDocRef.get();
                if (doc.exists) {
                    const userData = doc.data();
                    if (userData.isBanned) {
                        const banEndTime = userData.banEndTime;
                        const now = firebase.firestore.Timestamp.now();

                        if (banEndTime && banEndTime.seconds < now.seconds) {
                            await userDocRef.update({
                                isBanned: false,
                                banReason: firebase.firestore.FieldValue.delete(),
                                banEndTime: firebase.firestore.FieldValue.delete()
                            });
                            console.log(`User ${user.uid} unbanned as ban time expired.`);
                            hideLoadingScreen();
                            window.location.href = 'home.html';
                        } else {
                            console.log('User is banned. Logging out and showing popup.');
                            await auth.signOut();
                            hideLoadingScreen();
                            displayBanPopup(userData.banReason || 'Unusual activities', banEndTime);
                        }
                    } else if (!userData.username) {
                        console.log('User logged in but needs to create a username.');
                        pendingUserUid = user.uid;
                        hideLoadingScreen();
                        showUsernameForm();
                    }
                    else {
                        hideLoadingScreen();
                        window.location.href = 'home.html';
                    }
                } else {
                    console.warn('User document not found for UID:', user.uid);
                    // This scenario might happen if a user signs up via a different method
                    // (e.g., social login) and their profile isn't immediately created.
                    pendingUserUid = user.uid;
                    hideLoadingScreen();
                    showUsernameForm();
                }
            } catch (error) {
                console.error('Error checking ban status or user profile:', error.message);
                hideLoadingScreen();
                showAuthForms();
                alert('An error occurred. Please try again.');
            }
        }


        // Login User
        loginBtn.addEventListener('click', async () => {
            if (isUnderMaintenance) {
                showError(loginErrorMessage, 'Login is disabled due to server maintenance.');
                return;
            }

            const email = loginEmailInput.value;
            const password = loginPasswordInput.value;
            hideError(loginErrorMessage);
            loginBtn.disabled = true;

            if (!email || !password) {
                showError(loginErrorMessage, 'Please enter both email and password.');
                loginBtn.disabled = false;
                return;
            }

            showLoadingScreen('Logging in...'); // Show loading screen for login
            try {
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                console.log('User logged in:', userCredential.user);
                await checkBanStatusAndHandleLogin(userCredential.user);

            } catch (error) {
                hideLoadingScreen(); // Hide loading screen on error
                console.error('Login error:', error.message);
                switch (error.code) {
                    case 'auth/invalid-email':
                        showError(loginErrorMessage, 'Invalid email format.');
                        break;
                    case 'auth/user-disabled':
                        showError(loginErrorMessage, 'Your account has been disabled.');
                        break;
                    case 'auth/user-not-found':
                    case 'auth/wrong-password':
                        showError(loginErrorMessage, 'Invalid email or password.');
                        break;
                    default:
                        showError(loginErrorMessage, 'Login failed: ' + error.message);
                }
            } finally {
                loginBtn.disabled = false;
            }
        });

        // Signup User
        signupBtn.addEventListener('click', async () => {
            if (isUnderMaintenance) {
                showError(signupErrorMessage, 'Signup is disabled due to server maintenance.');
                return;
            }

            const email = signupEmailInput.value;
            const password = signupPasswordInput.value;
            const confirmPassword = signupConfirmPasswordInput.value;
            hideError(signupErrorMessage);
            signupBtn.disabled = true;

            if (!email || !password || !confirmPassword) {
                showError(signupErrorMessage, 'Please fill in all fields.');
                signupBtn.disabled = false;
                return;
            }

            if (password.length < 6) {
                showError(signupErrorMessage, 'Password should be at least 6 characters.');
                signupBtn.disabled = false;
                return;
            }

            if (password !== confirmPassword) {
                showError(signupErrorMessage, 'Passwords do not match.');
                signupBtn.disabled = false;
                return;
            }

            showLoadingScreen('Signing up...'); // Show loading screen for signup
            try {
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;
                console.log('User signed up:', user);

                pendingUserUid = user.uid;
                hideLoadingScreen(); // Hide loading screen before showing username form
                showUsernameForm();

            } catch (error) {
                hideLoadingScreen(); // Hide loading screen on error
                console.error('Signup error:', error.message);
                switch (error.code) {
                    case 'auth/email-already-in-use':
                        showError(signupErrorMessage, 'This email is already in use.');
                        break;
                    case 'auth/invalid-email':
                        showError(signupErrorMessage, 'Invalid email format.');
                        break;
                    case 'auth/weak-password':
                        showError(signupErrorMessage, 'Password is too weak.');
                        break;
                    default:
                        showError(signupErrorMessage, 'Signup failed: ' + error.message);
                }
            } finally {
                signupBtn.disabled = false;
            }
        });

        // Create Username
        createUsernameBtn.addEventListener('click', async () => {
            if (isUnderMaintenance) {
                showError(usernameErrorMessage, 'Cannot create username due to server maintenance.');
                return;
            }

            const username = usernameInput.value.trim();
            hideError(usernameErrorMessage);
            createUsernameBtn.disabled = true;

            if (!username) {
                showError(usernameErrorMessage, 'Please enter a username.');
                createUsernameBtn.disabled = false;
                return;
            }
            if (username.length < 3) {
                showError(usernameErrorMessage, 'Username must be at least 3 characters long.');
                createUsernameBtn.disabled = false;
                return;
            }
            if (!/^[a-zA-Z0-9_.]+$/.test(username)) {
                showError(usernameErrorMessage, 'Username can only contain letters, numbers, periods, and underscores.');
                createUsernameBtn.disabled = false;
                return;
            }


            if (!pendingUserUid) {
                showError(usernameErrorMessage, 'Error: User not identified for username creation. Please try signing up again.');
                createUsernameBtn.disabled = false;
                console.error('Pending user UID is null for username creation.');
                return;
            }

            const usersRef = db.collection('users');
            showLoadingScreen('Creating username...'); // Show loading screen for username creation
            try {
                const querySnapshot = await usersRef.where('username', '==', username).get();
                if (!querySnapshot.empty) {
                    showError(usernameErrorMessage, 'Username "' + username + '" is already taken. Please choose another.');
                    createUsernameBtn.disabled = false;
                    hideLoadingScreen(); // Hide loading screen
                    return;
                }

                await usersRef.doc(pendingUserUid).set({
                    uid: pendingUserUid,
                    username: username,
                    email: auth.currentUser ? auth.currentUser.email : '', // Use currentUser.email if available
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    isBanned: false,
                    banReason: null,
                    banEndTime: null,
                    postsCount: 0,
                    followersCount: 0,
                    followingCount: 0,
                    following: []
                }, { merge: true }); // Use merge to avoid overwriting if doc already exists from auth

                console.log('User profile created in Firestore for UID:', pendingUserUid);
                pendingUserUid = null;
                hideLoadingScreen(); // Hide loading screen
                window.location.href = 'home.html';

            } catch (error) {
                hideLoadingScreen(); // Hide loading screen on error
                console.error('Error creating user profile:', error.message);
                showError(usernameErrorMessage, 'Error creating username: ' + error.message);
            } finally {
                createUsernameBtn.disabled = false;
            }
        });

        // Initial setup on page load
        document.addEventListener('DOMContentLoaded', async () => {
            currentAppVersionSpan.textContent = CURRENT_APP_VERSION; // Display current app version

            const underMaintenance = await checkMaintenanceStatus();
            if (underMaintenance) {
                if (auth.currentUser) {
                    console.log('Logging out user due to maintenance.');
                    await auth.signOut();
                }
                hideLoadingScreen();
                // If under maintenance, stop here. Forms are disabled.
            } else {
                // If not under maintenance, check for app updates
                const updateShown = await checkForAppUpdates();
                
                if (!updateShown) {
                    // If no update modal is shown, proceed with auth state check immediately
                    auth.onAuthStateChanged((user) => {
                        if (user) {
                            console.log('User already logged in. Checking ban status.');
                            checkBanStatusAndHandleLogin(user);
                        } else {
                            hideLoadingScreen();
                            showAuthForms();
                        }
                    });
                } else {
                    // If an update modal IS shown, we need to defer the auth state check
                    // until the user interacts with the update modal.
                    auth.onAuthStateChanged((user) => {
                        if (user) {
                            authUserPendingCheck = user; // Store user for later check
                        } else {
                            // If no user is logged in, just hide loading screen
                            // The update modal is already visible
                            hideLoadingScreen(); 
                        }
                    });
                }
            }
        });

    </script>
</body>
</html>